<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ressources - eSportsConnect</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #111827; }
.card { background-color: #1f2937; border: 1px solid #374151; }
.btn-gradient { background-image: linear-gradient(to right, #3b82f6, #8b5cf6); }
.btn-gradient:hover { background-image: linear-gradient(to right, #2563eb, #7c3aed); }
#toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 50; display: flex; flex-direction: column; gap: 0.75rem; }
.toast { animation: slide-in 0.5s forwards, fade-out 0.5s 4s forwards; }
@keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fade-out { from { opacity: 1; } to { opacity: 0; } }
</style>
</head>
<body class="text-gray-200">

<div id="toast-container"></div>

<nav class="bg-gray-900/80 backdrop-blur-sm p-4 flex justify-between items-center sticky top-0 z-10 border-b border-gray-700">
    <a href="/dashboard.html" class="text-2xl font-bold text-white">eSports<span class="text-blue-500">Connect</span></a>
</nav>

<main class="p-8 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-4xl font-extrabold">Ressources et Guides</h2>
        <button id="show-resource-form-btn" class="hidden btn-gradient text-white font-bold py-2 px-6 rounded-lg flex items-center">
            <i data-lucide="plus-circle" class="mr-2 h-5 w-5"></i>Publier une ressource
        </button>
    </div>

    <!-- Formulaire de création de ressource (caché par défaut) -->
    <div id="resource-form-wrapper" class="hidden bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-2xl font-semibold mb-4">Nouvelle Ressource</h3>
        <form id="add-resource-form" class="space-y-4">
            <div>
                <label for="r-title" class="block text-sm font-medium">Titre</label>
                <input type="text" id="r-title" required class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="r-category" class="block text-sm font-medium">Catégorie</label>
                <input type="text" id="r-category" required class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Guide de jeu, Stratégie, Actualités...">
            </div>
            <div>
                <label for="r-content" class="block text-sm font-medium">Contenu</label>
                <textarea id="r-content" required rows="10" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Vous pouvez utiliser du Markdown pour la mise en forme."></textarea>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-resource-form-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Annuler</button>
                <button type="submit" class="btn-gradient text-white font-bold py-2 px-4 rounded">Publier</button>
            </div>
        </form>
    </div>

    <!-- Liste des ressources -->
    <div id="resources-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Les ressources seront injectées ici -->
    </div>
</main>

<script>
    lucide.createIcons();
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/';

    const showResourceFormBtn = document.getElementById('show-resource-form-btn');
    const cancelResourceFormBtn = document.getElementById('cancel-resource-form-btn');
    const resourceFormWrapper = document.getElementById('resource-form-wrapper');
    const addResourceForm = document.getElementById('add-resource-form');
    const resourcesListEl = document.getElementById('resources-list');
    const toastContainer = document.getElementById('toast-container');
    let currentUser = null;

    const showToast = (message, isError = false) => {
        const toast = document.createElement('div');
        toast.className = `toast p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4500);
    };

    const fetchCurrentUser = async () => {
        try {
            const res = await fetch('/api/users/me', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error('Session invalide');
            currentUser = await res.json();
            if (currentUser.role === 'coach' || currentUser.role === 'admin') {
                showResourceFormBtn.classList.remove('hidden');
            }
        } catch (error) {
            console.error(error);
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    };

    const fetchResources = async () => {
        resourcesListEl.innerHTML = `<div class="col-span-full flex justify-center items-center h-64"><i data-lucide="loader-2" class="animate-spin h-12 w-12"></i></div>`;
        lucide.createIcons();
        try {
            const res = await fetch('/api/resources', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error('Erreur de chargement des ressources.');
            const resources = await res.json();
            displayResources(resources);
        } catch (e) {
            resourcesListEl.innerHTML = `<p class="col-span-full text-red-500 text-center">${e.message}</p>`;
        }
    };

    const displayResources = (resources) => {
        if (resources.length === 0) {
            resourcesListEl.innerHTML = '<p class="col-span-full text-gray-400 text-center">Aucune ressource disponible pour le moment.</p>';
            return;
        }
        resourcesListEl.innerHTML = resources.map(resource => `
            <div class="card rounded-lg p-6 flex flex-col">
                <span class="text-xs font-semibold text-blue-400 mb-2">${resource.category.toUpperCase()}</span>
                <h4 class="text-2xl font-bold mb-2">${resource.title}</h4>
                <p class="text-sm text-gray-400 mb-4">Par ${resource.author.username} - ${new Date(resource.createdAt).toLocaleDateString('fr-FR')}</p>
                <p class="text-gray-300 flex-grow overflow-hidden text-ellipsis h-24">${resource.content.substring(0, 150)}...</p>
                <a href="#" class="mt-4 font-semibold text-blue-500 hover:text-blue-400 self-start">Lire la suite →</a>
            </div>
        `).join('');
    };

    showResourceFormBtn.addEventListener('click', () => {
        resourceFormWrapper.classList.toggle('hidden');
    });
    cancelResourceFormBtn.addEventListener('click', () => {
        resourceFormWrapper.classList.add('hidden');
    });

    addResourceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const resourceData = {
            title: document.getElementById('r-title').value,
            category: document.getElementById('r-category').value,
            content: document.getElementById('r-content').value,
        };
        try {
            const res = await fetch('/api/resources', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(resourceData)
            });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || "Erreur lors de la publication.");
            }
            addResourceForm.reset();
            resourceFormWrapper.classList.add('hidden');
            showToast('Ressource publiée avec succès !');
            await fetchResources();
        } catch (error) {
            showToast(error.message, true);
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchCurrentUser();
        await fetchResources();
    });
</script>
</body>
</html>